# IoT-Smart_Line

## Project Overview
The project uses Cartesi Rollups to build a DApp (Decentralized Application) with verifiable logic to verify the compliance and trust of public transportation.

This application is an combination of the projects:
 - https://github.com/arthuravianna/iot_rollups_dapp
 - https://github.com/EdLoivos/iot_prove_dapp

This module combines the ability to generate fines with the integrity generated by checking the quality of GPS data recived from busus and report attempts to decieve the application thrugh false data along the fines.


## Project Requirements
- npm
- nodeJS
- python3
- docker (version >= 20.10.12)

## Running the Dapp
To run the DApp is necessary to execute the front-end and the back-end.

### Back-End
The DApp back-end consists of the verifiable logic that will run inside Cartesi Rollups; this will store and update the application state given user input, and will produce outputs as vouchers (transactions that can be carried out on Layer1) and notices (informational). **The current version only uses notices**.

The first step to run the back-end is to create the container of a cartesi machine that contains the back-end logic and then run the production environment (containers).
#### Building the machine
To generate the container, use the command:
``` Bash
cartesi build
```
#### Running the machine
To launch the container, use the command:
``` Bash
cartesi run
```

### Front-End
The DApp front-end consists of a Web server developed in NodeJS, it's objective is to insteract with Cartesis's contracts in the Blockchain (Layer-1), and for that it uses the Web3.js module.

The server runs on port `3000` and has 4 routes:
- `/` : Dashboard containing info about the fines to be paid. To retrive this information the Web Server makes queries to the graphql server running on port `4000`. Each page of the dashboard has data of an different epoch;
- `/submit` : Doesn't have a page, it's the route used to send inputs(real-time GPS data or a schedules) to the Web server, the Web server will then forward this data to the Contract in the Blockchain and the Contract will forward it to the back-end. **This route uses a default hardhat account and is ideal for tests.**
- `/inspect` : Used to access the inspect state of the Cartesi Machine. In this app this feature is used to get information stored in the Database (SQLite) inside the Cartesi Machine, like the know bus lines or the route of a bus line.
- `/query` : Used to query emitted fines information in form of Histogram or Time Series.

#### Installing & Running

``` Bash
cd front_end
npm install
USE_LOCAL_ACCOUNT=1 node app.js
```
## DEMO
This demo interacts with the application via the curl command. This form of interaction is used for tests because it uses a "default" hardhat account to cover expenses of the contracts methods execution.
The first input sends a new schedule and the following ones simulate the inputs sent by a bus on that line.
``` Bash
curl -H "Content-Type: application/json" -d @demo/schedule1.json http://localhost:3000/submit

curl -H "Content-Type: application/json" -d '{"bus_id": "18C-Out", "trip_id":"18C;1","lat": 57.828261, "lon": 26.535419,"ts": "2022-03-25 07:45:50", "spd": 0, "links": [] }' http://localhost:3000/submit

curl -H "Content-Type: application/json" -d '{"bus_id": "18C-Inv", "trip_id":"18C;1", "lat": 57.829546205, "lon": 26.52836965,"ts": "2022-05-04 07:46:02", "spd": 0, "links": [] }' http://localhost:3000/submit
curl -H "Content-Type: application/json" -d '{"bus_id": "1X", "trip_id":"XX;0", "lat": 57.829546205, "lon": 26.52836965,"ts": "2022-05-04 07:46:02", "spd": 0, "links": [] }' http://localhost:3000/submit
curl -H "Content-Type: application/json" -d '{"bus_id": "2X", "trip_id":"XX;0", "lat": 57.827773871, "lon": 26.527908414,"ts": "2022-05-04 07:46:02", "spd": 0, "links": ["18C-Inv"] }' http://localhost:3000/submit
curl -H "Content-Type: application/json" -d '{"bus_id": "3X", "trip_id":"XX;0", "lat": 57.827499658, "lon": 26.526395549,"ts": "2022-05-04 07:46:02", "spd": 0, "links": ["18C-Inv"] }' http://localhost:3000/submit
curl -H "Content-Type: application/json" -d '{"bus_id": "4X", "trip_id":"XX;0", "lat": 57.827771014, "lon": 26.526290963,"ts": "2022-05-04 07:46:02", "spd": 0, "links": ["18C-Inv"] }' http://localhost:3000/submit

curl -H "Content-Type: application/json" -d '{"bus_id": "18C-Late", "trip_id":"18C;1", "lat": 57.82847892, "lon": 26.53362055,"ts": "2022-05-04 07:48:30", "spd": 0, "links": [] }' http://localhost:3000/submit

curl -H "Content-Type: application/json" -d '{"bus_id": "18C-Late", "trip_id":"18C;1", "lat": 57.85712539905671, "lon": 26.35578550850216,"ts": "2022-05-04 07:49:05", "spd": 0, "links": [] }' http://localhost:3000/submit

curl -H "Content-Type: application/json" -d '{"bus_id": "XX", "trip_id":"XX;0", "lat": 57.829546205, "lon": 26.52836965,"ts": "2022-05-04 07:50:01", "spd": 0, "links": [] }' http://localhost:3000/submit
```
